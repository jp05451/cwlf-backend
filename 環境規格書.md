### **兒福聯盟後端系統 - 環境規格書**

**版本**: 1.0
**日期**: 2025-08-06
**撰寫人**: 葉宜修

#### **1. 專案概覽**
本文件旨在詳細說明「兒福聯盟後端系統 (`cwlf-backend`)」專案的軟體環境規格、組件及其配置。本系統採用 Docker 容器化技術進行部署與管理，確保了環境的一致性與可攜性。

#### **2. 系統架構**
本系統由以下三個核心服務容器組成，透過 Docker Compose 進行統一編排：

*   **應用程式服務 (`app`)**: 核心後端應用，負責處理業務邏輯與 API 請求。
*   **資料庫服務 (`mysql_db`)**: 使用 MySQL 作為主資料庫，負責持久化儲存所有業務資料。
*   **消息佇列服務 (`rabbitmq`)**: 使用 RabbitMQ 作為消息代理，負責服務間的非同步通訊與任務解耦。

#### **3. 軟體依賴與版本**
| 組件 (Component) | 軟體/映像檔 (Image) | 版本 | 用途 |
| :--- | :--- | :--- | :--- |
| **應用程式框架** | Node.js | `18-alpine` | 執行 JavaScript 後端應用 |
| **資料庫** | MySQL Server | `9.4.0` | 關係型資料儲存 |
| **消息佇列** | RabbitMQ | `4-management` | AMQP 消息代理 |
| **部署工具** | Docker Engine | 28.3.3+ | 容器執行環境 |
| **編排工具** | Docker Compose | 2.39.1+ | 多容器應用編排 |

#### **4. 專案結構**
```
cwlf-backend/
├── app/                  # 後端應用程式原始碼目錄
│   ├── Dockerfile        # 應用程式的容器建置說明檔
│   ├── index.js          # 應用程式進入點
│   └── package.json      # Node.js 專案依賴定義
├── backups/              # 自動化資料庫備份存放目錄
├── backup.sh             # 自動化備份腳本
├── restore.sh            # 手動還原腳本
├── docker-compose.yml    # 基礎與開發環境定義檔
└── docker-compose.uat.yml # UAT 環境差異化定義檔
```

#### **5. 環境配置詳解 (`docker-compose.yml`)**

**5.1. 服務通訊埠映射 (Port Mapping)**
| 服務 | 容器內部 Port | 主機映射 Port (`dev`) | 主機映射 Port (`uat`) | 用途 |
| :--- | :--- | :--- | :--- | :--- |
| `app` | `3000` | `3000` | `8080` | 後端應用 API |
| `mysql_db` | `3306` | `3306` | `3306` | 資料庫連線 |
| `rabbitmq` | `5672` | `5672` | `5672` | RabbitMQ 服務連線 |
| `rabbitmq` | `15672`| `15672`| `15672`| RabbitMQ 管理介面 |

**5.2. 資料持久化 (Data Persistence)**
本系統使用 Docker Named Volumes 來持久化儲存服務資料，確保容器重啟後資料不遺失。
*   **`mysql-data`**: 用於儲存 MySQL 資料庫檔案。
*   **`rabbitmq-data`**: 用於儲存 RabbitMQ 的狀態與訊息。

**5.3. 環境變數 (Environment Variables)**
本系統透過環境變數向 `app` 容器傳遞配置，實現應用與配置的解耦。詳情請參閱 `docker-compose.yml` 中的 `app.environment` 區塊。

#### **6. 建置與部署流程**

**6.1. 開發環境 (`dev`)**
```bash
# 啟動所有服務，若 app 程式碼有更動則重新建置
docker compose up --build -d
```

**6.2. 使用者驗收測試環境 (`uat`)**
```bash
# 使用 uat 配置檔案啟動所有服務
docker compose -f docker-compose.yml -f docker-compose.uat.yml up -d
```
*備註: UAT 環境預期從 Docker Hub 拉取已發布的 `app` 映像檔 (`jp05451/cwlf-backend:1.0.0`)。*